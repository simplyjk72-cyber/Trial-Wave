<!DOCTYPE html>
<html>
<head>
<title>INSANE DEMON WAVE</title>
<style>
body { margin:0; overflow:hidden; background:black; }
canvas { display:block; }
</style>
</head>
<body>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

let gameState = "playing";
let score = 0;
let highScore = localStorage.getItem("waveHighScore") || 0;
let lastScoreTime = Date.now();

let baseSpeed = 12;
let speedMultiplier = 1;

let player = {
  x: 200,
  y: canvas.height/2,
  size: 14,
  hitbox: 9
};

let holding = false;

let segments = [];
let segmentWidth = 70;
let gapSize = 110;
let spawnX = canvas.width;
let lastCenterY = canvas.height/2;

// ---- Line Collision ----
function lineCollision(px, py, size, x1, y1, x2, y2){
  let cx = px + size/2;
  let cy = py + size/2;

  let dx = x2 - x1;
  let dy = y2 - y1;
  let length = Math.sqrt(dx*dx + dy*dy);

  let dot = ((cx-x1)*dx + (cy-y1)*dy) / (length*length);
  dot = Math.max(0, Math.min(1, dot));

  let closestX = x1 + dot*dx;
  let closestY = y1 + dot*dy;

  let distX = cx - closestX;
  let distY = cy - closestY;
  let distance = Math.sqrt(distX*distX + distY*distY);

  return distance < player.hitbox/2;
}

// ---- Spawn Connected Slopes ----
function spawnSegment(){

  let shift = (Math.random()*180 - 90);
  let centerY = lastCenterY + shift;

  // keep playable but still hard
  centerY = Math.max(80, Math.min(canvas.height-80, centerY));

  let top = centerY - gapSize/2;
  let bottom = centerY + gapSize/2;

  segments.push({
    x: spawnX,
    prevTop: lastCenterY - gapSize/2,
    prevBottom: lastCenterY + gapSize/2,
    top: top,
    bottom: bottom
  });

  lastCenterY = centerY;
  spawnX += segmentWidth;
}

for(let i=0;i<30;i++) spawnSegment();

// ---- Input ----
function startHold(){ if(gameState==="playing") holding=true; }
function stopHold(){ holding=false; }

document.addEventListener("keydown", e=>{
  if(["Space","KeyW","ArrowUp"].includes(e.code)) startHold();
  if(e.key==="r") location.reload();
});
document.addEventListener("keyup", e=>{
  if(["Space","KeyW","ArrowUp"].includes(e.code)) stopHold();
});
document.addEventListener("mousedown", e=>{ if(e.button===0) startHold(); });
document.addEventListener("mouseup", e=>{ if(e.button===0) stopHold(); });

// ---- Update Loop ----
function update(){

  ctx.fillStyle="black";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if(gameState==="dead"){
    ctx.fillStyle="white";
    ctx.font="40px Arial";
    ctx.fillText("INSANE DEMON - PRESS R", canvas.width/2-200, canvas.height/2);
    requestAnimationFrame(update);
    return;
  }

  // score
  let now = Date.now();
  if(now-lastScoreTime >= 500){
    score++;
    lastScoreTime = now;

    if(score % 10 === 0 && gapSize > 70){
      gapSize -= 4;
    }
    if(score % 15 === 0){
      speedMultiplier += 0.1;
    }
  }

  if(score > highScore){
    highScore = score;
    localStorage.setItem("waveHighScore", highScore);
  }

  let speed = baseSpeed * speedMultiplier;
  let waveSpeed = 7 * speedMultiplier;

  if(holding) player.y -= waveSpeed;
  else player.y += waveSpeed;

  // ---- Invisible vertical death bounds ----
  if(player.y < 0 || player.y + player.size > canvas.height){
    gameState = "dead";
  }

  ctx.fillStyle="cyan";
  ctx.fillRect(player.x, player.y, player.size, player.size);

  for(let s of segments){

    s.x -= speed;

    // Draw top slope
    ctx.strokeStyle="orange";
    ctx.lineWidth=4;
    ctx.beginPath();
    ctx.moveTo(s.x, s.prevTop);
    ctx.lineTo(s.x + segmentWidth, s.top);
    ctx.stroke();

    // Draw bottom slope
    ctx.beginPath();
    ctx.moveTo(s.x, s.prevBottom);
    ctx.lineTo(s.x + segmentWidth, s.bottom);
    ctx.stroke();

    // Collision
    if(
      lineCollision(player.x, player.y, player.size,
        s.x, s.prevTop,
        s.x+segmentWidth, s.top
      ) ||
      lineCollision(player.x, player.y, player.size,
        s.x, s.prevBottom,
        s.x+segmentWidth, s.bottom
      )
    ){
      gameState="dead";
    }

    if(s.x < -segmentWidth){
      segments.shift();
      spawnSegment();
    }
  }

  ctx.fillStyle="white";
  ctx.font="20px Arial";
  ctx.fillText("Score: "+score, 20, 40);
  ctx.fillText("Highscore: "+highScore, 150, 40);

  requestAnimationFrame(update);
}

update();
</script>
</body>
</html>

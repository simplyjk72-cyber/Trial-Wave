<!DOCTYPE html>
<html>
<head>
<title>Wave Game</title>
<style>
body { margin:0; overflow:hidden; background:black; }
canvas { display:block; }
</style>
</head>
<body>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

let gameState="playing";
let score=0;
let highScore=localStorage.getItem("waveHighScore")||0;
let lastScoreTime=Date.now();

let baseSpeed=6; // faster
let speedMultiplier=1;
let speedLevels=[0.5,1,2,3,4];

let player={
  x:150,
  y:canvas.height/2,
  normalSize:16,
  miniSize:8,
  size:16,
  isMini:false
};

let holding=false;
let borderTime=0;

let obstacles=[];
let portals=[];
let spawnX=canvas.width;

// -------- COLLISION ----------
function rectCollision(a,b){
  return(
    a.x < b.x + b.width &&
    a.x + a.size > b.x &&
    a.y < b.y + b.height &&
    a.y + a.size > b.y
  );
}

function triangleCollision(px,py,size,t){
  let cx=px+size/2;
  let cy=py+size/2;

  let area=Math.abs((t.x2-t.x1)*(t.y3-t.y1)-(t.x3-t.x1)*(t.y2-t.y1));
  let a1=Math.abs((t.x1-cx)*(t.y2-cy)-(t.x2-cx)*(t.y1-cy));
  let a2=Math.abs((t.x2-cx)*(t.y3-cy)-(t.x3-cx)*(t.y2-cy));
  let a3=Math.abs((t.x3-cx)*(t.y1-cy)-(t.x1-cx)*(t.y3-cy));

  return Math.abs(area-(a1+a2+a3))<0.5;
}

// -------- SPAWNING ----------
function spawnChunk(){

  // Wall
  obstacles.push({
    type:"block",
    x:spawnX,
    y:Math.random()*(canvas.height-300),
    width:40,
    height:250
  });

  // Connected slope floor->ceiling
  let height=200;
  obstacles.push({
    type:"slopeUp",
    x:spawnX+120,
    width:200,
    height:height
  });

  obstacles.push({
    type:"slopeDown",
    x:spawnX+320,
    width:200,
    height:height
  });

  // Double spikes
  obstacles.push({ type:"spike", x:spawnX+550, size:40 });
  obstacles.push({ type:"spike", x:spawnX+600, size:40 });

  spawnX+=800;
}

for(let i=0;i<6;i++) spawnChunk();

function spawnPortal(){
  let type=Math.random()<0.5?"speed":"size";

  let portal={
    x:spawnX,
    type:type
  };

  if(type==="speed"){
    let possible=speedLevels.filter(s=>s!==speedMultiplier);
    portal.value=possible[Math.floor(Math.random()*possible.length)];
  }else{
    portal.value=player.isMini?"normal":"mini";
  }

  portals.push(portal);
  spawnX+=150;
}

// -------- RESET ----------
function reset(){
  score=0;
  speedMultiplier=1;
  player.isMini=false;
  player.size=player.normalSize;
  player.y=canvas.height/2;
  lastScoreTime=Date.now();
  borderTime=0;
  gameState="playing";
  obstacles=[];
  portals=[];
  spawnX=canvas.width;
  for(let i=0;i<6;i++) spawnChunk();
}

// -------- INPUT ----------
function startHold(){ if(gameState==="playing") holding=true; }
function stopHold(){ holding=false; }

document.addEventListener("keydown",e=>{
  if(["Space","KeyW","ArrowUp"].includes(e.code)) startHold();
  if(e.key==="r") reset();
});
document.addEventListener("keyup",e=>{
  if(["Space","KeyW","ArrowUp"].includes(e.code)) stopHold();
});
document.addEventListener("mousedown",e=>{ if(e.button===0) startHold(); });
document.addEventListener("mouseup",e=>{ if(e.button===0) stopHold(); });

// -------- UPDATE ----------
function update(){

  ctx.fillStyle="black";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if(gameState==="dead"){
    ctx.fillStyle="white";
    ctx.font="40px Arial";
    ctx.fillText("YOU DIED - PRESS R",canvas.width/2-180,canvas.height/2);
    requestAnimationFrame(update);
    return;
  }

  let now=Date.now();
  if(now-lastScoreTime>=500){
    score++;
    lastScoreTime=now;
    if(score%40===0) spawnPortal();
  }

  if(score>highScore){
    highScore=score;
    localStorage.setItem("waveHighScore",highScore);
  }

  let speed=baseSpeed*speedMultiplier;

  if(holding) player.y-=4*speedMultiplier;
  else player.y+=4*speedMultiplier;

  if(player.y<=5||player.y+player.size>=canvas.height-5){
    borderTime++;
    if(borderTime>25) gameState="dead";
  } else borderTime=0;

  if(player.y<5) player.y=5;
  if(player.y+player.size>canvas.height-5)
    player.y=canvas.height-player.size-5;

  // Borders
  ctx.fillStyle="white";
  ctx.fillRect(0,0,canvas.width,5);
  ctx.fillRect(0,canvas.height-5,canvas.width,5);

  // UI
  ctx.font="20px Arial";
  ctx.fillText("Score: "+score,20,40);
  ctx.fillText("Highscore: "+highScore,150,40);

  // Player
  ctx.fillStyle="cyan";
  ctx.fillRect(player.x,player.y,player.size,player.size);

  // -------- OBSTACLES --------
  for(let o of obstacles){
    o.x-=speed;

    if(o.type==="block"){
      ctx.fillStyle="red";
      ctx.fillRect(o.x,o.y,o.width,o.height);
      if(rectCollision(player,o)) gameState="dead";
    }

    if(o.type==="slopeUp"){
      let t={
        x1:o.x,
        y1:canvas.height-5,
        x2:o.x+o.width,
        y2:canvas.height-5,
        x3:o.x+o.width,
        y3:5
      };

      ctx.fillStyle="orange";
      ctx.beginPath();
      ctx.moveTo(t.x1,t.y1);
      ctx.lineTo(t.x2,t.y2);
      ctx.lineTo(t.x3,t.y3);
      ctx.closePath();
      ctx.fill();

      if(triangleCollision(player.x,player.y,player.size,t))
        gameState="dead";
    }

    if(o.type==="slopeDown"){
      let t={
        x1:o.x,
        y1:5,
        x2:o.x+o.width,
        y2:5,
        x3:o.x+o.width,
        y3:canvas.height-5
      };

      ctx.fillStyle="orange";
      ctx.beginPath();
      ctx.moveTo(t.x1,t.y1);
      ctx.lineTo(t.x2,t.y2);
      ctx.lineTo(t.x3,t.y3);
      ctx.closePath();
      ctx.fill();

      if(triangleCollision(player.x,player.y,player.size,t))
        gameState="dead";
    }

    if(o.type==="spike"){
      let baseY=canvas.height-5;
      let t={
        x1:o.x,
        y1:baseY,
        x2:o.x+o.size/2,
        y2:baseY-o.size,
        x3:o.x+o.size,
        y3:baseY
      };

      ctx.fillStyle="yellow";
      ctx.beginPath();
      ctx.moveTo(t.x1,t.y1);
      ctx.lineTo(t.x2,t.y2);
      ctx.lineTo(t.x3,t.y3);
      ctx.closePath();
      ctx.fill();

      if(triangleCollision(player.x,player.y,player.size,t))
        gameState="dead";
    }

    if(o.x<-300) spawnChunk();
  }

  // -------- PORTALS --------
  for(let p of portals){
    p.x-=speed;

    ctx.fillStyle = p.type==="speed" ? "cyan":"magenta";
    ctx.fillRect(p.x-25,0,50,canvas.height);

    ctx.fillStyle="black";
    ctx.font="40px Arial";

    if(p.type==="speed"){
      let arrows="";
      if(p.value===0.5) arrows="↓";
      if(p.value===1) arrows="→";
      if(p.value===2) arrows="↑↑";
      if(p.value===3) arrows="↑↑↑";
      if(p.value===4) arrows="↑↑↑↑";
      ctx.fillText(arrows,p.x-20,canvas.height/2);
    } else {
      ctx.fillText("S",p.x-10,canvas.height/2);
    }

    if(player.x+player.size>p.x-25 &&
       player.x<p.x+25){

      if(p.type==="speed") speedMultiplier=p.value;
      else{
        if(p.value==="mini"){
          player.isMini=true;
          player.size=player.miniSize;
        }else{
          player.isMini=false;
          player.size=player.normalSize;
        }
      }

      p.x=-9999;
    }
  }

  requestAnimationFrame(update);
}

update();
</script>
</body>
</html>
